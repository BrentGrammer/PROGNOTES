# CI/CD in AWS - Code Cimmit and Code Deploy

- AWS CodePipeline is an orchestration tool that links together:
  - CodeCommit
  - CodeBuild (used for building and testing step in CI/CD)
  - CodeDeploy
- **For exam: A Pipeline is linked to only one branch in a repository**

### Key files

- `buildspec.yml` or `buildspec.json` - spec for CodeBuild
  - https://docs.aws.amazon.com/codebuild/latest/userguide/build-spec-ref.html
  - Can be part of your source code commited or defined when you create a build project in AWS
- `appspec.yml` or `appspec.json` - spec for CodeDeploy
  - https://docs.aws.amazon.com/codedeploy/latest/userguide/reference-appspec-file.html
  - Influences how the deployment of code occurs

## CodeDeploy

### Deployment destinations:

- Can be used to deploy an app onto EC2 instances
  - using a deployment group
- Can deploy to AWS Elastic Beanstalk (specify environment name) or AWS OpsWorks (specify a stack)
- Can deploy using AWS CloudFormation
  - create a new stack or update an existing stack
  - update or create a new change set
- Can deploy into AWS ECS
  - can use Blue/Green deployment model
- Can deploy into Service Catalog or Alexa Skill
- Can deploy onto S3
- AWS Lambda
- On Premises

### Deployment

- Only used to deploy code, not resources
- Can deploy code, web apps, configuration, EXE files, Packages, Scripts, media and more
- **Need an agent installed when deploying to EC2 instances or On Premises servers**

### appspec.yml

- Controls how deployments occur on the target of the deployment
- Manages config and lifecycle event hooks

#### Configuration/sections in the appspec.yml file

- Files (applies to EC2/On-Premises targets)
  - specifies which files should be installed on the instance during the deployment
- Resources (only applies to ECS and AWS Lambda targets)
  - Controls details of the resource (i.e. the lambda) used for the deployment
  - Configures the thing running your application (i.e. the ECS container, the lambda function, etc.)
- Permissions (applies to EC2/On-premises targets)
  - Specifies any special permissions and how they apply to the files and folders defined in the Files section

#### Lifecycle hooks

- `ApplicationStop` (used to prepare for the deployment itself), `DonwloadBundle` (when code deploy agent copies app down to temporary location), `BeforeInstall` (pre-installation tasks, create backups, etc.), `Install` (code deploy agent copies app files from temp location to destination folder, cannot run any scripts during this step), `AfterInstall` (perform post install steps, app specific config or changing file permissions, etc.), `ApplicationStart` (restart or start services stopped during the `ApplicationStop` event), `ValidateService` (verify deployment completed successfully, check logs etc.)
  - For EC2 deployment, runs one or more scripts for each of the hooks
  - If deploying to lambda or ECS, each hook specifies lambda functions to run on the event

## Code Commit

- [Walkthrough of features](https://learn.cantrill.io/courses/1101194/lectures/30415185)

## AWS Pipeline

- Continuous Delivery tool
- Controls flow from source > build > deployment
- built from Stages (can architect the stages however you want)
  - Stages have **Actions**
    - Actions can be a single action, parallel actions, or sequential actions
  - Movement between Stages can be automatic or require approval
- Actions in stages can generate artifacts or have artifacts loaded to them
  - Artifacts are objects in a S3 bucket linked to the pipeline
  - Input Artifacts (loaded and consumed by the action)
  - Output Artifacts: generated by the action and output to S3
  - Artifacts/code builds etc. are moved from one stage as output artifacts and to another stage as input artifacts
- Stage Changes are published to the Event Bridge event bus
  - Success, Failed, Cancelled
  - Can perform actions triggered by these events, notifications, etc.
- Can use Cloudtrail or Console UI for interaction
