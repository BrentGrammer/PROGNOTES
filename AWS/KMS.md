# Key Management Service (KMS)

- [Video](https://learn.cantrill.io/courses/1101194/lectures/25997309)
- Regional and Public Service
  - Every region is isolated when using KMS (think of it as a separate product)
- Create, Store and Manage cryptographic keys
  - Handles both symmetric and Asymmetric keys
  - can encrypt and decrypt values
- **Keys never leave KMS**
  - Keys are locked inside the product
  - they can be imported, managed etc., but they stay inside KMS
  - Provides a FIPS 140-2(L2) U.S. security standard
    - The L2 (Level 2 compliance) is important and differentiates KMS from other services
    - **important for the exam**

## KMS Keys

- Also referred to as CMKs (Customer Master Keys) in the past
- Can be used by you, applications and other AWS Services
- They are a logical container for the data that makes up the key
  - Contains ID, date (creation), resource policy, description and key state
  - contains actual data that are the keys and they are used to encrypt and decrypt data you give to KMS
  - Keys can encrypt or decrypt data up to 4KB in size
- The physical key data can be generated by KMS or imported to KMS
- **KMS Keys are stored in the specific region of the KMS service (regional) and never leave that region or the KMS service**
- Keys are either AWS owned (services own and manage them for multiple accounts and operate in the background - you usually don't deal with them) or Customer owned (what you usually work with)
  - Customer owned are two types: AWS Managed (auto created by AWS when you use a service that integrates with KMS) and Customer Managed (created explicitly by you to use in an app or service, more configurable)
  - Rotation is supported by both types (can't be disabled on AWS managed keys and happens once a year)
- KMS Keys contain the Backing Key (physical data for the key) and all backing keys from previous rotations

  - Data with older keys can still be decrypted
  - Can create aliases to keys as well so rotation does not affect or cause issues

    - aliases are per region (neither aliases or keys are global by default)

  - Note: multi-region keys are supported where they are replicated to other AWS regions

- **Everything in KMS is stored in encrypted form** - nothing is stored in plain text
  - In memory the data could be plain text, but on disc everything is stored encrypted

### Encryption in KMS

- Key is created with `createKey`, this is encrypted and stored in KMS
- Make an encrypt call to KMS specifying which key to use and send data to encrypt
  - Note that the key is not sent with or leaves the KMS service, you just say which key you want to use
- KMS accepts the data and checks permissions to use the key specified in KMS
- KMS then decrypts the specified key and uses it to encrypt the data sent in the request
- KMS finally returns the encrypted data

### Decryption in KMS

- Request to decrypt sent to KMS with the encrypted data
  - You do not need to specify which key to use to decrypt - this is encoded in the encrypted data sent
- Permissions are checked for a decrypt operation with a specific key (decrypt permissions are separate from encrypt and key generation permissions - all are separate)
- KMS decrypts the key needed and uses it to decrypt the encrypted data sent and returns the decrypted data back

## Permissions

- Permissions are very granular in KMS
  - You can give permissions to create keys, but not to decrypt or encrypt
  - Common requirement when you need administrators to have generational operation permissions, but not encryption, for example
- You need permissions to encrypt, permissions to decrypt, and permissions to use specific keys all separately
- This is called "Role Separation"
- Permissions for KMS do not allow by default for account they were created in like other services, you need to explicitly allow permissions for identities

### Key Polcies

- A resource policy that only exists on Keys
- Used to explicitly tell the KMS keys to trust the account they are contained within (must explicitly allow this)
- Every KMS Key has a key policy, for customer owned keys you can change them.
  - Example policy needed to grant access to a key using identity policies

```json
{
  "Sid": "Enable IAM User Permissions",
  "Effect": "Allow",
  "Principal": { "AWS": "arn:aws:iam::111222333:root" }, // allow account 11122233 to manage the key
  "Action": "kms:*",
  "Resource": "*"
}

// Identity policy to give someone the right to encrypt or decrypt
{
    "Version": "2012-10-17",
    "Statement": {
        "Effect": "Allow",
        "Action": [
            "kms:Encrypt",
            "kms:Decrypt"
        ],
        "Resource": [
            "arn:aws:kms:*:111222333:key/"
        ]
    }
}

```

- Generally you create a policy like this to trust an account, and then create Identity policies to allow IAM users to interact with the key
  - In high security environments, you might not trust the account, but have all specific permissions inside the key policy
- Note you can also use policies with Grants

## Data Encryption Keys (DEKs) - for encrypting data that is more than 4KB

- Another type of Key that KMS can generate
- They are generated with KMS Keys using the `GenerateDataKey` operation
  - These keys can be used to encrypt data larger than 4KB in size (the limit in KMS)
- DEKs are linked to the KMS key that created them
- **KMS DOES NOT STORE DEKs** - These keys are created, provided to you and then discarded in KMS
  - KMS Does not actually use DEKs for encrypting/decrypting data - You, or the AWS service using it, use the keys to do that yourself.

### DEK generation

- Two versions of a DEK are provided on creation
  - Plaintext version (can be used immediately)
  - Ciphertext version (the key is encrypted using the KMS key that generated it)
    - This encrypted key can be given back to KMS in the future to be decrypted and used

### Encrypting/Decrypting with DEKs

- You only generate a DEK immediately before you want to encrypt something
- Encrypt the data initially with the plaintext version of the DEK, then discard the plaintext version of the key
- Store the encrypted data along with the ciphertext (encrypted) version of the DEK with it
  - Note that KMS does not track DEKs or do the actual encryption of the data (you or the service using KMS does that)
  - You always have the data and encryption key needed to decrypt it on disc, but they are both encrypted so security is maintained
- DECRYPTION:
  - pass the encrypted DEK back to KMS which decrypts it with the same KMS key used to encrypt it
  - Use the decrypted DEK KMS returns to you to decrypt the data, and then discard the DEK
- NOTE: services such as s3 when using KMS, generate a DEK for each object - they encrypt the object and discard the plaintext version of the DEK
