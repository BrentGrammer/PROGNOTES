# IAM

- **Global** resilient service
  - Any data is secure across all Regions
- Audit using Credential reports or Access Advisor (lists which roles/permissions have been used or not and can be removed)
  - Find access advisor in User page - it's one of the tabs
- Every Account comes with it's own IAM database instance separate from all other accounts.
- IDP - Identity Provider Platform that lets you create modify or delete identities.
- Authenticates and Authorizes Identities (Security Principals):
  - **Security Principal**: identities that are asking permissions or access to resources.
- Free no cost service
- Note: You cannot control external identities in other accounts or what they can do in external accounts, only identities within the account.

## Identity Types

### Users

- For people or applications.
- Use when you can identify individuals to grant permissions to.
- [Create an IAM User demo](https://learn.cantrill.io/courses/1101194/lectures/25335803)
  - Includes Cloudformation template at 3:20

#### Limits:

- **Only max of 5,000 users allowed per account** (IAM is global so not per region)
- IAM User can be a member of at max 10 groups
- Design implications: cannot have more than 5k user using a IAM user
  - Internet scale with millions of users
  - Large orgs with more than 5k needed.
  - IAM users are not the right identity to use for these cases, instead you need to use IAM roles or federation

### Groups

- Collections of related users.
  - i.e. a "Development team" group
- Recommended security practice is to give users Identity permissions from the Group

### Roles

- a type of Identity that should be used over an IAM User identity when you do not know the number of identities you need to have or they exceed 5,000 (the limit for IAM User Identities)

#### Can have 2 types of Policies

- Trust Policy: specifies which IAM identities are allowed to assume a particular role
  - Can reference identities including users in other AWS accounts, services (i.e. EC2 or S3 etc.), allow for anonymous identities, and facebook, twitter etc.
  - Identities that are allowed to assume the role are given generated temporary security credentials (i.e. time limited access keys)
    - These are generated by STS (Secure Token Service): the permission operation is `sts:AssumeRole`
    - identities can re-assume a role if needed to get new temp creds.
- Permissions Policy: allow or deny actions
  - The temporary credentials will reference the permissions policy for the role. If the permissions policy is changed, those creds will reflect the updated permissions.

#### Use Cases for ROLES

- Can be used by AWS services or to grant external access to services in account to uncertain number of entities.
- Generally used for a short period of time - an identity assumes a role for a limited time.
  - Identities use a role and the permissions it has for a short time.
- Can be used with AWS Organizations to allow one time loging to access multiple AWS accounts.
- Also useful in emergency or out of normal "break glass" scenarios
  - Users (i.e. a support member) can assume an emergency role temporarily to gain extra write permissions over normal read for example if a problem needs to be fixed quickly.
- Useful when adding AWS to an existing corporate environment
  - see [example](https://learn.cantrill.io/courses/1101194/lectures/25335807) at 8:12
  - Ex: if you have an existing identity provider(i.e. MSFT Active Directory) already and can use single sign on which allows them to use their existing logins to access AWS.
    - Note if there are more than 5,000 staff, you can't use IAM users, so using a role is required here to reuse existing identities for use within AWS
      - External Identities CANNOT be used directly with AWS accounts - a separate process is needed (reference Identity Federation: allowing external identities to assume an AWS Role so they can execute actions).
    - Key Advantage:
      - No credentials stored in the app for AWS (the role manages them and they're temporary)
      - Makes use of existing customer logins, no need for another account for access for them
      - enables scaling beyond the 5,000 iam user limit.
- **USEFUL FOR MOBILE APPLICATIONS** to scale with millions of users so you don't have to use IAM Users with 5000 limit - this is on the exam
- Useful for cross account access. Can use roles to give access to a complete separate account. Multi account management and access becomes simple with Roles.

### Roles for services (Service-linked roles)

- IAM Role linked to a specific service
- Comes with permissions that are predefined by the service
  - Come with permissions that a service needs to interact with other services o,n your behalf.
- Can be created by the service itself, you, or during the setup process of that service or by IAM.
- **KEY DIFFERENCE BETWEEN SERVICE LINKED ROLES AND REGULAR IAM ROLES**: You CANNOT delete a service linked role until it is no longer in use or required by the service.
- Instead of hard coding keys into a service like AWS Lambda, we can create a role for these services to execute actions with permissions.

  - Ex: AWS Lambda Execution Role
  - see [illustration](https://learn.cantrill.io/courses/1101194/lectures/25335807) at 2:00
  - Code inside the lambda runtime can use the temporary credentials (given by sts:AssumeRole) to execute actions against other AWS resources, etc.

    - \*Without a ROLE you would have needed to hard code access keys in the lambda code for it to use for actions. Roles come with auto generated short term creds automatically.

- In the IAM policy, you need to use the `role/aws-service-role` and specify a specific resource name
  - **You need to look up the specific service name for service linked roles and use that**. Format can differ and is case sensitive

#### Role Separation (with PassRole)

- You give one group an ability to create roles and another group the ability to use roles
- To give someone the ability to take on a service-linked role (to use it, but not crate or manage it etc.), you need to allow them the `iam:PassRole` Action.

```json
{
  "Effect": "Allow",
  "Action": ["iam:ListRole", "iam:PassRole"],
  "Resource": "arn:aws:iam::12345:role/my-role-for-xyz"
}
```

- This allows this identity to pass a existing role into an AWS service
  - allows the user to configure a service using a role that was already created by a member of the security team.
  - This role that the user passes may have permissions that exceed those that they normally have without it.

## IAM Policies

- Document Objects that are used to Allow or Deny permissions to resources when they are attached to IAM Users, Groups or Roles.

### Policy Documents

- A policy document is one or more statements
- AWS knows which authenticated identities have which policies (an identity can have multiple policies)
  - AWS will move through each of the statements one by one to determine if any apply to interacting with a particular resource in a particular way.
- Interactions with resources in AWS is a combination of two main things:
  - The resource you're interacting with
  - The action you're taking on that resource. (example interacting with an AWS s3 bucket and the action is adding a object to it)
  - **Statements only apply if the resource and the action being taken on it match**

### Actions

- actions are in the format: `{service}:{action}`

### Example policy:

```jsonc
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Sid": "FullAccess", // Sid: optional field to identify what the statement does, best practice to always use these
      "Effect": "Allow",
      "Action": ["s3:*"],
      "Resource": ["*"]
    },
    {
      "Sid": "DenyCatBucket",
      "Effect": "Deny",
      "Action": ["s3:*"],
      "Resource": ["arn:aws:s3:::catgifs", "arn:aws:s3:::catgifs/*"]
    }
  ]
}
```

### Statement Priority

- If there is overlap in the statements, all statements are processed, and priorities are given.
- First Priority: explicit Denys
  - Denys for a specific resource will overrule everything else - in the above example, the Deny overrides the Allow s3:\* statement.
- Second Priority: Explicit Allows
  - Take affect UNLESS there is also an explicit DENY.
- Third Priority: Default Implicit DENY
  - If you're attempting to do something not specified in the statements, then it is Deny by default and not permitted.

### Policy Aggregation

- If there are multiple policies involved for an action (a user policy, a group policy that the user belongs to, and a resource policy for example), then all statements are evaluated and if there is any explicit DENY in any of them - that wins.
  - Same priority rules listed above apply across all statements and policies.

  **Resource Policy**: (a policy that is attached to a resource instead of an IAM identity)

### Only Root user has access by default

- All Identities are denied access to all resources by default except the account root user.
- If there are not ALLOW statements, then the user has no access.

### 2 Types of Policies

- Inline policies: i.e. policies per user, not good practice for many users
  - Should only be used for Special or exceptional individual cases (i.e. applied to one user)
  - see [demo](https://learn.cantrill.io/courses/1101194/lectures/25335803) at 8:26 for creating an inline policy for a user.
- Managed Policies: it's own object that you can attach to multiple users. Best practice is to use managed policies.
  - Reusable
  - Low management overhead
  - Example: `IAMUserChangePassword` - allows an IAM user to change their own password or reset it.
  - see [demo](https://learn.cantrill.io/courses/1101194/lectures/25335803) at 11:43 for attaching a managed policy to a user.
    - IAM > Users > Add permission > Attach policy directly

#### Resource Policies

- attached to a resource (i.e. s3) and allows or denys actions for a particular principal or IAM identity for that resource.
- references the IAM identity via an ARN.
  - Note: A IAM Group is NOT an identity and cannot be referenced as a principal

### IAM Users

- an identity used for anything requiring long term AWS access
  - Humans, Applications or service accounts
- If you can picture one thing or a named thing/user that needs to access resources, then the correct identity to select for that should be an IAM User.

### Principal

- An entity trying to access an AWS account
  - Starts as unidentified
  - Can be individuals, copmuters, services or groups any of those things
- In order for a principal to do anything, it needs to be authenticated and authorized.

#### Authentication

- A Principal needs to prove that it is who it claims to be and authenticate against an IAM identity (i.e. an IAM User)
  - with Username and Password
    - a human user
  - with Access Keys (using the secret access key)
    - an application
    - a human using the cli tools
- After a principal is authenticated, AWS checks IAM policy statements for that identity to determine if they can perform an action etc. (Authorization)

## ARNS

- Amazon Resource Names
- Uniquely identify resources (in the same account or different accounts)
- `arn:partition:service:region:account-id:resource-id`
- `arn:partition:service:region:account-id:resource-type/resource-id`
- `arn:partition:service:region:account-id:resource-type:resource-id`
  - Example:
    - `arn:aws:s3:::catgifs` - this specifies a bucket (not the objects in it)
    - `arn:aws:s3:::catgifs/*` - this specifies everything in that bucket (not the bucket itself)
    - note the double colons are because you don't need to specify the region etc. for s3 buckets or the account id since s3 is global accross accounts, this is not a wildcard \* or the same thing as that.

### Can be attached to users

- ARNs can be defined for IAM users and identities

## IAM Groups

- Containers for IAM Users
- Soley for managing large sets of IAM Users and adding policies/permissions for them
  - i.e. Developers and a QA group
  - make groups that represent teams or projects etc.
- **Note: groups have no credentials of their own and you cannot log in to a group**
- **The same IAM User can be a member of multiple groups**
- Groups can have IAM policies attached to them.
- [Demo of creating a user group](https://learn.cantrill.io/courses/1101194/lectures/25335805) at timestamp 5:09

### Limits

- 300 groups per account (can be increased with a support ticket)
- There is NO LIMIT for number of users in a IAM group (5,000 is the IAM user limit for an account)
- Note: there is NO All Users group built in (trick question on exam)
  - You could optionally create a group with all the users in it, but it does not exist natively
- There can be NO NESTING of groups (i.e. groups within groups)
- **A IAM Group is NOT an Identity and cannot be referenced by ARN etc. as a Principal in a policy**
  - i.e. you can't reference a group in a IAM resource policy.

## STS Security Token Service

- Generates temporary credentials whenever the `sts:AssumeRole` operation is used.
  - These credentials are used by the identity that assumes the role.
- Similar to access keys: contain a public key and a secret access key.
  - **The crucial difference is that these credentials expire and are no longer usable**
- **These credentials are requested by another identity** such as another IAM user or an external identity such as google, facebook, twitter etc. (Web Identity Federation)

### Trust Policy

- A wall around the role which controls which group of identities can assume that role.
  - Identities that want to assume the role must be in the trust policy

### Assume role requests

- The `sts:AssumeRole` calls must come from an identity - this could be a IAM user, AWS service, or external web identity
- These calls are made via the STS service - when they're made, the Trust policy is checked, and also the permissions policy which is attached to the role.
  - STS uses the permissions policy to generate the temporary creds.
- The temprorary cresd are linked to the permissions policy on the role
  - If the permissions policy changes, then the permissions the creds have access to change in real time

### Credentials properties

- AccessKeyId: unique ID for the credentials
- Expiration: Date and time of expiration
- SecretAccessKey: used to sign requests to services
- SessionToken: unique token that must be included with all requests

### Used by lots of architectures in AWS

- AssumeRole
- Switching accounts in the UI
- cross account access using roles
- Identity Federation
